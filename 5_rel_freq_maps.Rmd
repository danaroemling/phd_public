---
title: "Relative Frequency Mapping"
author: "Dana"
date: '2022-11-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Mapping with Relative Frequency

This Rmd is just an updated version of the mappings in 3_first_maps to include the relative frequency. I start with the relevant libraries and the data loading.

```{r libs}
# libraries
library(stringr) # regex
library(dplyr) # regex
library(tidyverse) # mapping
library(rworldmap) # mapping

# data
corpus <- read.csv(file = './data_ling/train_70.csv')
```

Then I count, as usual, the occurrence of a token. 

```{r counting}
# this counts the occurrence of a feature in the corpus
regcount <- function(corp, word1, case = FALSE, neg = FALSE){
  
  # Set case/regex
  word1 <- paste('\\b', word1, '\\b', sep ="") 
  word1 <- regex(word1, ignore_case = !case)
  
  # Extract indexes with at least one hit
  hits1 <- str_which(string = corp,  pat = word1,  negate = neg)   
  
  # Cities
  cities1<- corpus$location[hits1] 
  
  c1<-as.data.frame(table(cities1))
  
  c1[is.na(c1)] <- 0
  
  # This will be the structures for output
  output <- c()
  output <- c1
  
  # Output results  
  return(output)
}

reg_output <- regcount(corp = corpus$message, word1 = "nix", case = FALSE) # this is the execution of the search
colnames(reg_output) <- c("City", "Frequency") # this gives new column names
```

I then load in the coordinates and merge with by city detail with the count data. 

```{r merging}
longlat <- read.csv(file = './data_maps/gsa_geo_filtered.csv') # geolocation data loaded
merger_one <- merge(reg_output, longlat, by.x ="City", by.y = "City") # this merges geolocation and counts

```

Now I can add the relative frequency. For that I load the counts of all tokens at all locations. This information is merged with the data and the coordinates details. With that in one object, the relative frequency can be calculated. 

```{r relative frequency}
token_at_location <- read.csv(file = './data_ling/tokens_at_location.csv') # load token data
colnames(token_at_location) <- c("City", "Tokencount") # give column names
merger <- merge(merger_one, token_at_location, by.x ="City", by.y = "City")
merger$relfreq <- (merger$Frequency/merger$Tokencount)
merger$relfreq1000 <- (merger$relfreq*1000)
colnames(merger) <- c("City", "Frequency", "lon", "lat", "TokenCount", "RelativeFrequency", "RelativeFrequencyThousand")
```

Then the usual map preparation is done:

```{r map prep}
worldMap <- getMap()
DACH <- c("Germany", "Austria", "Switzerland")
DACH_map <- which(worldMap$NAME%in%DACH)
DACH_coord <- lapply(DACH_map, function(i){
  df <- data.frame(worldMap@polygons[[i]]@Polygons[[1]]@coords)
  df$region =as.character(worldMap$NAME[i])
  colnames(df) <- list("long", "lat", "region")
  return(df)
})
DACH_coord <- do.call("rbind", DACH_coord)
```

And now I can map the relative frequency:

```{r map plot}
ggplot() + geom_polygon(data = DACH_coord, 
                        aes(x = long, y = lat, group = region),
                        colour = "black", 
                        size = 0.1, 
                        fill = "gray95") + 
  coord_map(xlim = c(4.5, 17),  
            ylim = c(45.5, 55)) + 
  theme_minimal() +  
  geom_point(data = merger, 
             aes(x = lon, y = lat, size = RelativeFrequencyThousand),
             colour = "darkorchid4",
             alpha = 0.7)  +
  #geom_text(data = merger, aes(x = lng, y = lat, label=city), hjust=0.1, vjust=0.1, size = 2) +
  guides(color = "none") +
  labs(size="Relative\nFrequency") +
  ggtitle("'nix' in the GSA") +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major = element_blank(),
        plot.title = element_text(hjust = 0.5))
```

The plot can be exported using ggsave.

```{r export}
ggsave("./output/mistkÃ¼bel.png", width = 6.5, height = 5.5)
```

